@model IEnumerable<Probe.Models.Game>

@{
    ViewBag.Title = "Index";
}

<link href="@Url.Content("~/Content/themes/custom-dialog/jquery-ui.min.css")"
      rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/themes/base/jquery.ui.dialog.css")"
      rel="stylesheet" type="text/css" />

<script src="@Url.Content("~/Scripts/probe/probe-setup-tablesorter.js")"
        type="text/javascript"></script>

@helper RenderChoices(Probe.Models.Game item)
{
        
    <div id="menuOptionsDiv" style="float: left">
        <label for="menuOptions"></label>
        <select name="menuOptions" id="menuOptions" data-gameid="@item.Id" data-gametype="@item.GameType.Name" data-code="@item.Code" data-pcount="@item.Players.Count()">
            <option>Selection</option>
            <option>Edit</option>
            <option>Details</option>
            <option>Config</option>
            <option>Questions</option>
            @if (item.Published) {<option>Unpublish</option>} else {<option>Publish</option>}
            @if (item.Players.Count > 0) {<option>Players</option>}
            @if (ViewBag.DctAllGamesActiveStatus[item.Id]) {<option>Preview</option>}
            @if (item.Players.Count > 0) {<option>Report</option>}
            <option>Clone</option>
            @if (!ViewBag.DctAllGamesActiveStatus[item.Id] && item.Players.Count == 0)
            {<option>Delete</option>}
        </select>
    </div>
}


<h2>My Games</h2>

<p>
    @Html.ActionLink("Create New", "Create")
</p>

<div>
    <table class="tablesorter">
        <thead>
            <tr>
                <th>
                    @Html.DisplayNameFor(model => model.Name)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.GameType.Name)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.StartDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.EndDate)
                </th>
                <th>
                    Players
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Published)
                </th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.GameType.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.StartDate)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.EndDate)
                    </td>
                    <td>
                        @if (item.Players.Count > 0)
                        {
                            <a class="playersDialogLink" data-gameid="@item.Id" data-code="@item.Code" data-gametype="@item.GameType.Name"
                               href="#">@Html.DisplayFor(modelItem => item.Players.Count)</a>
                        }
                        else
                        {
                        <a data-gameid="@item.Id" data-gametype="@item.GameType.Name"  
                           href="#">@Html.DisplayFor(modelItem => item.Players.Count)</a>
                            
                        }
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Published)
                    </td>
                    <td>
                        @RenderChoices(item)
                    </td>
                </tr>
            }

        </tbody>
    </table>
    @Html.Partial("TablesorterPager")
</div>

@*
BELOW ARE THE HTML DIV'S TO SUPPORT THE REPORT, PREVIEW, 
AND PLAYERS JQUERY UI MODAL DIALOGS    
*@
<div id="dialog-preview" title="Game Play Preview" />
<div id="dialog-players" title="Game Play Players">
    <fieldset>
        <div id="PplayersDiv" style="float: left">
            <label for="Pplayers">Player</label>
            <select name="Pplayers" id="Pplayers"></select>
        </div>
    </fieldset>
</div>
<div id="dialog-report" title="Game Play Report">
    <fieldset>
        <div id="reportTypeDiv" style="float: left">
            <label for="reportType">Report</label>
            <select name="reportType" id="reportType"></select>
        </div>
        <div id="RplayersDiv" style="float: left">
            <label for="Rplayers">Player</label>
            <select name="Rplayers" id="Rplayers"></select>
        </div>
        <div id="reportMessageDiv"></div>
    </fieldset>
</div>
<div id="dialog-info" title="Title">
    <fieldset>
        <div id="infoTextDiv"></div>
    </fieldset>
</div>

<div id='spinner'></div>

@if (ViewBag.ResultMessage != null) 
{
    <script type="text/javascript">
        $('#infoTextDiv').html('@Html.Raw(Ajax.JavaScriptStringEncode(ViewBag.ResultMessage.Message))');
        $("#dialog-info").attr('title','@ViewBag.ResultMessage.MessageType')
        $("#dialog-info").show();
        $("#dialog-info").dialog({
            resizable: false,
            width: 400,
            height: 200,
            modal: true,
            buttons: {
                "Close": function () {
                    $(this).dialog('close');
                }
            }
        });//$("#dialog-players").dialog({

    </script>
}

<script type="text/javascript">

    $(function () {

        //BIND GAME PLAY - PREVIEW DIALOG
        $("#dialog-preview").dialog({
            autoOpen: false,
            //position: { my: 'top', at: 'top+55' },
            resizable: true,
            draggable: true,
            modal: true,
        });

        //BIND GAME PLAY - REPORT DIALOG
        $("#dialog-report").dialog({
            autoOpen: false,
            resizable: false,
            width: 400,
            height: 200,
            modal: true,
            buttons: {
                "OK": function () {

                    //get selected report name
                    reportName = $('select[name="reportType"]').val();

                    playerId = $('select[name="Rplayers"] option:selected').attr('data-playerId');

                    reportURL = "";
                    if (gameType == 'Match') {
                        if (reportName == "Game Match Summary") {
                            reportURL = 'Reports/GamePlayerMatchMinMax/' + gameId + '/' + code;
                        } else if (reportName == "Player Match Summary") {
                            reportURL = 'Reports/PlayerMatchSummary/' + gameId + '/' + code + '/' + playerId;
                        }
                    } else if (gameType == 'Test') {
                        reportURL = 'Reports/PlayerTestSummary/' + gameId + '/' + code;
                    } else if (gameType == 'Last Man Standing') {
                        if (reportName == "Game LMS Summary") {
                            reportURL = 'Reports/GameLMSSummary/' + gameId + '/' + code;
                        } else if (reportName == "Player LMS Summary") {
                            reportURL = 'Reports/PlayerLMSSummary/' + gameId + '/' + code + '/0';
                        } else if (reportName == "Player LMS Detail") {
                            reportURL = 'Reports/PlayerLMSDetail/' + gameId + '/' + code + '/' + playerId;
                        }
                }

                    window.location = reportURL;

                },
                Cancel: function () {
                    $(this).dialog('close');
                }
            }
        });//$("#dialog-report").dialog({

        //BIND MENU OPTION EVENT HANDLERS FOR ACTIONS ON THE GAME PLAY GRID
        $('select[name="menuOptions"]').change(function () {

            ActivityIndicatorOn('#spinner');

            gameId = $(this).attr('data-gameid');
            gameType = $(this).attr('data-gametype');
            code = $(this).attr('data-code');
            playerCount = $(this).attr('data-pcount');

            switch ($(this).val()) {
                case 'Preview':
                    ShowPreviewDialog(code, 'TestName', 'TestName');
                    break;
                case 'Players':
                    window.location = 'Players?SelectedGame=' + gameId;
                    break;
                case 'Report':
                    ShowReportDialog(code, gameId, gameType, playerCount);
                    break;
                case 'Edit':
                    window.location = 'Games/Edit/' + gameId;
                    break;
                case 'Publish':
                    window.location = 'Games/Publish/' + gameId + '/1';
                    break;
                case 'Unpublish':
                    window.location = 'Games/Publish/' + gameId + '/0';
                    break;
                case 'Clone':
                    window.location = 'Games/Clone/' + gameId;
                    break;
                case 'Details':
                    window.location = 'Games/Details/' + gameId;
                    break;
                case 'Config':
                    window.location = 'GameConfigurations?SelectedGame=' + gameId;
                    break;
                case 'Questions':
                    window.location = 'GameQuestions?SelectedGame=' + gameId;
                    break;
                case 'Delete':
                    window.location = 'Games/Delete/' + gameId;
                    break;
            }

            $(this).val('Selection'); //reset selection menu back to default
            ActivitySelectorOff('#spinner');

        }); //$('select[name="menuOptions"]').change(function () {

        //BIND PLAYERS COUNT COLUMN CLICK WITH THE PLAYERS DIALOG
        $('.playersDialogLink').click(function () {

            gameCode = $(this).attr('data-code');
            $.getJSON('/api/Players/GetPlayerByGameCode/' + gameCode, {},
            function (data) {

                $('select[name="Pplayers"]').empty();
                data.forEach(function (value, index, ar) {
                    $('select[name="Pplayers"]').append('<option data-playerid="' + value.Id + '">' + value.PlayerGameName + '</option>');
                });

                $("#dialog-players").show();
                $("#dialog-players").dialog({
                    resizable: false,
                    width: 400,
                    height: 200,
                    modal: true,
                    buttons: {
                        "Close": function () {
                            $(this).dialog('close');
                        }
                    }
                });//$("#dialog-players").dialog({

            });//post
        });//$('#playersDialogLink').click

        $('.tablesorter tr').click(function () {
            $('.tablesorter tr').removeClass('selected-row-class');
            $(this).addClass('selected-row-class')
        });

    }); //$(function () {

    function ShowPreviewDialog(code, firstName, nickName) {
        url = 'Client/main.html'
            + '?code=' + code + '&firstname=' + firstName + '&nickname=' + nickName //the client doesn't pick up the firstname or lastname which is fine.
            + '&root=' + '@Request.Url.Authority' + '@Url.Content("~")'; //i.e root = localhost/Probe/ OR localhost:4430/ OR ..


        iframeHtml = '<iframe id="modalIframeId" width="100%" height="99%" marginWidth="0" marginHeight="0" ' +
                     'frameBorder="0" scrolling="no"/>';

        //responsive ui. mod the size of the jquery dialog to a certain point; then we have to use an instance of the browser
        if ($(window).height() > 720) {
            dHeight = 700; 
            $("#dialog-preview").html(iframeHtml).dialog("open").dialog({ height: dHeight, width: 500, resizable: true });
            $("#modalIframeId").attr("src", url);
        } else {
            browswerProps = 'titlebar=no,toolbars=no,menubar=no,location=no,scrollbars=yes,resizable=yes,status=no,width=500' +
                            ',height=' + Math.round($(window).height() * 0.80) +
                            ',left=' + (Math.round($(window).width() / 2) - 250) +
                            ',top=' + (Math.round($(window).height() * 0.10));

            window.open(url, '_blank', browswerProps);
        }

        return false;
    }//function ShowPreviewDialog

    function ShowReportDialog(code, gameId, gameType, playerCount) {

        $.getJSON('api/Players/GetPlayerByGameCode/' + code, {},
        function (data) {

            if (gameType == 'Match') {
                if (playerCount > 1) {
                    $('#reportTypeDiv').show();
                    $('#reportMessageDiv').hide();
                    $('select[name="reportType"]').empty();
                    $('select[name="reportType"]').append('<option>Game Match Summary</option><option>Player Match Summary</option><option>Player Match Stats</option>');
                } else {
                    $('#reportTypeDiv').hide();
                    $('#reportMessageDiv').html('At least two players must have submitted game plays to generate a report.');
                }
            } else if (gameType == 'Test') {
                $('#reportTypeDiv').show();
                $('#reportMessageDiv').hide();
                $('select[name="reportType"]').empty();
                $('select[name="reportType"]').append('<option>Game Test Scores</option><option>Game Test Stats</option>');
            } else if (gameType == 'Last Man Standing') {
                $('#reportTypeDiv').show();
                $('#reportMessageDiv').hide();
                $('select[name="reportType"]').empty();
                $('select[name="reportType"]').append('<option>Game LMS Summary</option><option>Player LMS Summary</option><option>Player LMS Detail</option>');
            }

            $('select[name="reportType"]').change(function () {
                //show players select menu when appropriate
                switch ($('select[name="reportType"]').val()) {
                    case 'Game Match Summary':
                        $('#RplayersDiv').hide();
                        break;
                    case 'Player Match Summary':
                        $('#RplayersDiv').show();
                        break;
                    case 'Player Match Stats':
                        $('#RplayersDiv').hide();
                        break;
                    case 'Game Test Scores':
                        $('#RplayersDiv').hide();
                        break;
                    case 'Game Test Stats':
                        $('#RplayersDiv').hide();
                        break;
                    case 'Game LMS Summary':
                        $('#RplayersDiv').hide();
                        break;
                    case 'Player LMS Summary':
                        $('#RplayersDiv').hide();
                        break;
                    case 'Player LMS Detail':
                        $('#RplayersDiv').show();
                        break;
                }

            });

            //fill the players selection menu
            $('select[name="Rplayers"]').empty();
            data.forEach(function (value, index, ar) {
                $('select[name="Rplayers"]').append('<option data-playerid="' + value.Id + '">' + value.PlayerGameName + '</option>');
            });

            $('#dialog-report').dialog('open');
            $('#RplayersDiv').hide(); //hide the players selection initially because a first selection doesnt need player selection


        });//post
    } //function ShowReportDialog

</script>
